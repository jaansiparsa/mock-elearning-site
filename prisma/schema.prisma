generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  email                  String                 @unique
  password               String
  firstName              String
  lastName               String
  username               String                 @unique
  role                   String                 @default("student")
  avatarUrl              String                 @default("https://placekitten.com/200/200")
  notificationPreference Boolean                @default(true)
  preferredStudyTime     String                 @default("morning")
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  lastLearned            DateTime?
  currentStreak          Int                    @default(0)
  achievements           Achievement[]
  submissions            AssignmentSubmission[]
  courses                Course[]               @relation("CourseInstructor")
  enrollments            CourseEnrollment[]
  ratings                CourseRating[]
  learningEvents         LearningEvent[]
  progressSummary        ProgressSummary?
  quizSubmissions        QuizSubmission[]
  studySessions          StudySession[]

  @@index([email])
  @@index([username])
  @@index([role])
}

model Course {
  courseId        String               @id @default(cuid())
  title           String
  description     String
  thumbnailUrl    String               @default("https://placekitten.com/400/300")
  category        String
  difficultyLevel String
  instructorId    String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  assignments     Assignment[]
  instructor      User                 @relation("CourseInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  enrollments     CourseEnrollment[]
  requiredBy      CoursePrerequisite[] @relation("RequiredByCourses")
  prerequisites   CoursePrerequisite[] @relation("CoursePrerequisites")
  ratings         CourseRating[]
  learningEvents  LearningEvent[]
  lessons         Lesson[]
  studySessions   StudySession[]

  @@index([instructorId])
  @@index([category])
  @@index([difficultyLevel])
}

model CoursePrerequisite {
  id             String   @id @default(cuid())
  courseId       String
  prerequisiteId String
  createdAt      DateTime @default(now())
  prerequisite   Course   @relation("RequiredByCourses", fields: [prerequisiteId], references: [courseId], onDelete: Cascade)
  course         Course   @relation("CoursePrerequisites", fields: [courseId], references: [courseId], onDelete: Cascade)

  @@unique([courseId, prerequisiteId])
  @@index([courseId])
  @@index([prerequisiteId])
}

model Lesson {
  lessonId          String             @id @default(cuid())
  courseId          String
  title             String
  description       String
  order             Int
  estimatedTime     Int
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  assignments       Assignment[]
  learningEvents    LearningEvent[]
  course            Course             @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  lessonCompletions LessonCompletion[]
  studySessions     StudySession[]

  @@index([courseId])
  @@index([order])
}

model CourseEnrollment {
  enrollmentId      String             @id @default(cuid())
  studentId         String
  courseId          String
  enrolledAt        DateTime           @default(now())
  course            Course             @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  student           User               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lessonCompletions LessonCompletion[]

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

model LessonCompletion {
  completionId String           @id @default(cuid())
  enrollmentId String
  lessonId     String
  completedAt  DateTime         @default(now())
  lesson       Lesson           @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  enrollment   CourseEnrollment @relation(fields: [enrollmentId], references: [enrollmentId], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
}

model CourseRating {
  ratingId  String   @id @default(cuid())
  courseId  String
  studentId String
  rating    Float
  review    String?
  createdAt DateTime @default(now())
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [courseId], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([courseId])
  @@index([studentId])
}

model Assignment {
  assignmentId   String                 @id @default(cuid())
  courseId       String
  lessonId       String?
  title          String
  description    String
  points         Int
  rubricUrl      String?
  createdAt      DateTime               @default(now())
  lesson         Lesson?                @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  course         Course                 @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  submissions    AssignmentSubmission[]
  learningEvents LearningEvent[]
  studySessions  StudySession[]

  @@index([courseId])
  @@index([lessonId])
}

model AssignmentSubmission {
  submissionId      String     @id @default(cuid())
  studentId         String
  assignmentId      String
  startedAt         DateTime?
  endedAt           DateTime?
  grade             Float?
  feedback          String?    // Instructor feedback
  submissionContent String?    // Student's submission notes
  fileUrl           String?    // URL to uploaded file
  fileName          String?    // Original filename
  assignedAt        DateTime   @default(now())
  dueDate           DateTime
  status            String     @default("not_started")
  submittedAt       DateTime?  // When the submission was made
  assignment        Assignment @relation(fields: [assignmentId], references: [assignmentId], onDelete: Cascade)
  student           User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, assignmentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@index([dueDate])
  @@index([submittedAt])
}

model StudySession {
  sessionId    String      @id @default(cuid())
  userId       String
  courseId     String
  lessonId     String?
  assignmentId String?
  startTime    DateTime    @default(now())
  endTime      DateTime?
  duration     Int
  notes        String?
  assignment   Assignment? @relation(fields: [assignmentId], references: [assignmentId], onDelete: Cascade)
  lesson       Lesson?     @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  course       Course      @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([lessonId])
  @@index([assignmentId])
}

model LearningEvent {
  eventId      String      @id @default(cuid())
  userId       String
  courseId     String
  lessonId     String?
  assignmentId String?
  eventType    String
  eventData    String?
  createdAt    DateTime    @default(now())
  assignment   Assignment? @relation(fields: [assignmentId], references: [assignmentId], onDelete: Cascade)
  lesson       Lesson?     @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  course       Course      @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([lessonId])
  @@index([assignmentId])
  @@index([eventType])
}

model Achievement {
  achievementId String   @id @default(cuid())
  studentId     String
  badgeType     String
  earnedAt      DateTime @default(now())
  student       User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([badgeType])
}

model QuizSubmission {
  submissionId String   @id @default(cuid())
  quizId       String
  studentId    String
  score        Float
  submittedAt  DateTime @default(now())
  student      User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([studentId])
}

model ProgressSummary {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  totalCoursesEnrolled      Int      @default(0)
  totalLessonsCompleted     Int      @default(0)
  totalAssignmentsCompleted Int      @default(0)
  averageGrade              Float    @default(0)
  totalStudyTime            Int      @default(0)
  lastUpdated               DateTime @default(now())
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
